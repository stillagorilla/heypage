#!/usr/bin/env bash
set -euo pipefail
# Load env the same way dj does, then run psql against DATABASE_URL
# (simple approach: call dj to print DATABASE_URL not needed; we parse .env directly)
cd /srv/heypage/app
if [[ -f /srv/heypage/.env ]]; then
  while IFS= read -r line || [[ -n "$line" ]]; do
    line="${line#"${line%%[![:space:]]*}"}"
    line="${line%"${line##*[![:space:]]}"}"
    [[ -z "$line" || "${line:0:1}" == "#" ]] && continue
    if [[ "$line" =~ ^[A-Za-z_][A-Za-z0-9_]*= ]]; then
      key="${line%%=*}"
      val="${line#*=}"
      if [[ ( "${val:0:1}" == "\"" && "${val: -1}" == "\"" ) || ( "${val:0:1}" == "'" && "${val: -1}" == "'" ) ]]; then
        val="${val:1:-1}"
      fi
      export "${key}=${val}"
    fi
  done < /srv/heypage/.env
fi
: "${DATABASE_URL:?DATABASE_URL not set}"
exec psql "$DATABASE_URL" "$@"
